digraph WMF {
  splines=true;
  sep = 1;
  node [shape=box];
  subgraph web_traffic {
    the_internet -> ssl_terminators;
    the_internet -> frontend_varnish [style=dashed];
    ssl_terminators -> frontend_varnish;
    frontend_varnish -> backend_varnish [style=tapered, penwidth=10, arrowhead=none];
    backend_varnish -> {web:apache, api:hhvm};
    {web:hhvm, api:hhvm} -> {mysql_master, mysql_slave, redis, elasticsearch, swift};
    elasticsearch -> elasticsearch [style=tapered, penwidth=10, arrowhead=none];
  }
  subgraph jobs {
    // These arrows are reversed so dot will throw these nodes under the web_traffic ones
    edge [color="#8800cc", dir="back"]
    {mysql_master, mysql_slave, redis, elasticsearch} -> jobrunner;
    {mysql_master, mysql_slave, swift} -> imagescaler;
    /*
     * While technically Elasticsearch does forward request to itself for jobs as well as web
     * traffic, it makes the graph really hard to read when its on there so I've commented it
     * out. Hopefully its still obvious.
     */
    // elasticsearch -> elasticsearch [dir="forward", style=tapered, penwidth=10, arrowhead=none];
  }
  subgraph replication {
    edge [color="#880000"]
    mysql_master -> mysql_slave;
    elasticsearch -> elasticsearch [style=tapered, penwidth=10, arrowhead=none];
  }

  the_internet [shape=tripleoctagon];
  web [shape=record, label="web | {<apache>apache | <hhvm>hhvm}"]
  api [shape=record, label="api | {<apache>apache | <hhvm>hhvm}"]
}
